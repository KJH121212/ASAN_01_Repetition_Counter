# ============================================================
# build_yolo_staging.py
# âœ… metadata.csv ê¸°ë°˜ â†’ YOLO í•™ìŠµìš© ìŠ¤í…Œì´ì§•(ì‹¬ë³¼ë¦­ ë§í¬) + dataset.yml ìƒì„±
#    - ì›ë³¸ í´ë” êµ¬ì¡°/íŒŒì¼ì€ ë³€ê²½í•˜ì§€ ì•ŠìŒ
#    - íŒŒì¼ëª… ì¶©ëŒ ë°©ì§€: <dirhash>__<basename> í˜•ì‹ìœ¼ë¡œ ë§í¬ ìƒì„±
#    - Ultralytics v8 ê·œì¹™ ì¤€ìˆ˜: path/images/* ì™€ path/labels/* ì§ë§ì¶¤
#    - ë¼ë²¨ ê¸°ì¤€ìœ¼ë¡œ ì´ë¯¸ì§€ë¥¼ ì°¾ì•„ ë§¤ì¹­í•˜ë¯€ë¡œ "ì´ë¯¸ì§€ ë§ìŒ/ê²½ë¡œ í©ì–´ì§" ë¬¸ì œë¥¼ íšŒí”¼
# ============================================================

import os                   # ì‹¬ë³¼ë¦­ ë§í¬ ìƒì„± ë° OS ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ê¸° ìœ„í•œ ëª¨ë“ˆ
import hashlib              # ê²½ë¡œ ë¬¸ìì—´ì„ ì§§ì€ í•´ì‹œë¡œ ë³€í™˜í•˜ê¸° ìœ„í•œ ëª¨ë“ˆ
from pathlib import Path    # ê²½ë¡œ ì²˜ë¦¬ë¥¼ í¸ë¦¬í•˜ê²Œ í•˜ê¸° ìœ„í•œ ëª¨ë“ˆ
import pandas as pd         # metadata.csv ë¡œë“œë¥¼ ìœ„í•œ ëª¨ë“ˆ
import yaml                 # dataset.yml ìƒì„±ì„ ìœ„í•œ ëª¨ë“ˆ

# ------------------------------------------------------------
# ê²½ë¡œ ì„¤ì •
# ------------------------------------------------------------
BASE_DIR = Path("/workspace/nas203/ds_RehabilitationMedicineData/IDs/Kimjihoo/ASAN_01_Repeatition_Counter")  # í”„ë¡œì íŠ¸ ë£¨íŠ¸ ê²½ë¡œ
CSV_PATH = BASE_DIR / "data/metadata_backup.csv"       # ë©”íƒ€ë°ì´í„° CSV ê²½ë¡œ
STAGE_ROOT = BASE_DIR / "data/_yolo_stage"      # YOLOê°€ ì½ì„ ìŠ¤í…Œì´ì§• ë£¨íŠ¸(ì‹¬ë³¼ë¦­ ë§í¬ ëª¨ìŒ) ê²½ë¡œ
OUT_YAML = BASE_DIR / "data/dataset.yml"        # YOLO dataset.yml ì¶œë ¥ ê²½ë¡œ

# ------------------------------------------------------------
# ìœ í‹¸ í•¨ìˆ˜
# ------------------------------------------------------------
def short_hash(text: str, n: int = 8) -> str:
    """ì£¼ì–´ì§„ ë¬¸ìì—´ì— ëŒ€í•´ nê¸€ì ê¸¸ì´ì˜ ì§§ì€ í•´ì‹œë¥¼ ë°˜í™˜í•œë‹¤."""
    return hashlib.sha1(text.encode("utf-8")).hexdigest()[:n]  # SHA1 í•´ì‹œë¥¼ ê³„ì‚°í•´ ì• nê¸€ìë¥¼ ë°˜í™˜í•œë‹¤.

def ensure_dir(p: Path) -> None:
    """ë””ë ‰í† ë¦¬ê°€ ì—†ìœ¼ë©´ ìƒì„±í•œë‹¤."""
    p.mkdir(parents=True, exist_ok=True)  # ìƒìœ„ í´ë”ê¹Œì§€ í¬í•¨í•´ ì•ˆì „í•˜ê²Œ ë””ë ‰í† ë¦¬ë¥¼ ë§Œë“ ë‹¤.

def try_find_image(frame_dir: Path, stem: str) -> Path:
    """ë¼ë²¨ íŒŒì¼ëª…ê³¼ ë™ì¼í•œ stemì„ ê°€ì§„ ì´ë¯¸ì§€ë¥¼ í™•ì¥ì ìš°ì„ ìˆœìœ„ë¡œ ì°¾ì•„ ë°˜í™˜í•œë‹¤."""
    for ext in [".jpg", ".jpeg", ".png", ".bmp", ".webp"]:  # ì¼ë°˜ì ì¸ ì´ë¯¸ì§€ í™•ì¥ì í›„ë³´ë¥¼ ë‚˜ì—´í•œë‹¤.
        cand = frame_dir / f"{stem}{ext}"                   # í›„ë³´ ì´ë¯¸ì§€ ê²½ë¡œë¥¼ ë§Œë“ ë‹¤.
        if cand.exists():                                   # í›„ë³´ê°€ ì‹¤ì œë¡œ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸í•œë‹¤.
            return cand                                     # ì¡´ì¬í•˜ë©´ í•´ë‹¹ ê²½ë¡œë¥¼ ë°˜í™˜í•œë‹¤.
    raise FileNotFoundError(f"ì´ë¯¸ì§€ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ: {frame_dir}/{stem}.*")  # ì—†ìœ¼ë©´ ì˜ˆì™¸ë¥¼ ë°œìƒì‹œí‚¨ë‹¤.

def symlink_force(src: Path, dst: Path) -> None:
    """dstê°€ ìˆìœ¼ë©´ ì§€ìš°ê³  srcë¡œ í–¥í•˜ëŠ” ì‹¬ë³¼ë¦­ ë§í¬ë¥¼ ìƒì„±í•œë‹¤."""
    if dst.exists() or dst.is_symlink():                    # ëŒ€ìƒ ê²½ë¡œì— íŒŒì¼ ë˜ëŠ” ë§í¬ê°€ ì´ë¯¸ ìˆëŠ”ì§€ í™•ì¸í•œë‹¤.
        dst.unlink()                                        # ê¸°ì¡´ ê²ƒì„ ì‚­ì œí•´ ì¶©ëŒì„ ë°©ì§€í•œë‹¤.
    os.symlink(src, dst)                                    # ì†ŒìŠ¤ íŒŒì¼ì„ ê°€ë¦¬í‚¤ëŠ” ì‹¬ë³¼ë¦­ ë§í¬ë¥¼ ìƒì„±í•œë‹¤.

# ------------------------------------------------------------
# ë©”ì¸ ë¹Œë“œ í•¨ìˆ˜
# ------------------------------------------------------------
def build_stage_from_metadata(csv_path: Path, stage_root: Path, out_yaml: Path) -> None:
    """metadata.csvë¥¼ ì½ì–´ ìŠ¤í…Œì´ì§•(links)ê³¼ dataset.ymlì„ ìƒì„±í•œë‹¤."""
    df = pd.read_csv(csv_path)                                          # CSV íŒŒì¼ì„ ë¡œë“œí•œë‹¤.
    required = ["frame_path", "yolo_pose_path", "is_train", "is_val"]   # í•„ìš”í•œ ì»¬ëŸ¼ ëª©ë¡ì„ ì •ì˜í•œë‹¤.
    for c in required:                                                  # ê° í•„ìˆ˜ ì»¬ëŸ¼ì„ ìˆœíšŒí•œë‹¤.
        if c not in df.columns:                                         # ì»¬ëŸ¼ì´ ì—†ìœ¼ë©´ ì˜ˆì™¸ë¥¼ ë˜ì§„ë‹¤.
            raise ValueError(f"metadata.csvì— '{c}' ì»¬ëŸ¼ì´ ì—†ìŠµë‹ˆë‹¤.")   # ëª…í™•í•œ ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ ì œê³µí•œë‹¤.

    # ìŠ¤í…Œì´ì§• ë””ë ‰í† ë¦¬ ì¤€ë¹„
    img_tr = stage_root / "images" / "train"    # í•™ìŠµ ì´ë¯¸ì§€ ë§í¬ í´ë” ê²½ë¡œë¥¼ ì •ì˜í•œë‹¤.
    img_va = stage_root / "images" / "val"      # ê²€ì¦ ì´ë¯¸ì§€ ë§í¬ í´ë” ê²½ë¡œë¥¼ ì •ì˜í•œë‹¤.
    lb_tr = stage_root / "labels" / "train"     # í•™ìŠµ ë¼ë²¨ ë§í¬ í´ë” ê²½ë¡œë¥¼ ì •ì˜í•œë‹¤.
    lb_va = stage_root / "labels" / "val"       # ê²€ì¦ ë¼ë²¨ ë§í¬ í´ë” ê²½ë¡œë¥¼ ì •ì˜í•œë‹¤.
    for d in [img_tr, img_va, lb_tr, lb_va]:    # ë„¤ ê²½ë¡œë¥¼ ëª¨ë‘ ìˆœíšŒí•œë‹¤.
        ensure_dir(d)                           # ì—†ìœ¼ë©´ ìƒì„±í•œë‹¤.

    # ìƒì„± í†µê³„ ì¹´ìš´í„°
    n_tr, n_va = 0, 0  # í•™ìŠµ/ê²€ì¦ ë§í¬ ìƒì„± ê°œìˆ˜ë¥¼ ì§‘ê³„í•œë‹¤.

    # ê° í–‰(frame_dir â†” label_dir ìŒ)ì„ ì²˜ë¦¬
    for _, row in df.iterrows():                    # ë©”íƒ€ë°ì´í„°ì˜ ëª¨ë“  í–‰ì„ ìˆœíšŒí•œë‹¤.
        frame_dir = Path(row["frame_path"])         # í•´ë‹¹ ìƒ˜í”Œì˜ ì´ë¯¸ì§€ í´ë”ë¥¼ ê°€ì ¸ì˜¨ë‹¤.
        label_dir = Path(row["yolo_pose_path"])     # í•´ë‹¹ ìƒ˜í”Œì˜ YOLO í¬ì¦ˆ ë¼ë²¨ í´ë”ë¥¼ ê°€ì ¸ì˜¨ë‹¤.
        use_train = bool(row["is_train"])           # í•™ìŠµì— ì‚¬ìš©í• ì§€ ì—¬ë¶€ë¥¼ ì–»ëŠ”ë‹¤.
        use_val = bool(row["is_val"])               # ê²€ì¦ì— ì‚¬ìš©í• ì§€ ì—¬ë¶€ë¥¼ ì–»ëŠ”ë‹¤.

        if not (use_train or use_val):                  # ë‘˜ ë‹¤ ì•„ë‹ˆë©´ ì´ í–‰ì„ ê±´ë„ˆë›´ë‹¤.
            continue
        if not label_dir.exists():                      # ë¼ë²¨ í´ë”ê°€ ì—†ìœ¼ë©´ ê²½ê³ í•˜ê³  ê±´ë„ˆë›´ë‹¤.
            print(f"[WARN] ë¼ë²¨ í´ë” ì—†ìŒ â†’ {label_dir}")    # ì‚¬ìš©ìì—ê²Œ ê²½ê³ ë¥¼ ì¶œë ¥í•œë‹¤.
            continue

        prefix = short_hash(str(label_dir.resolve()))  # ë¼ë²¨ í´ë” ê²½ë¡œë¡œë¶€í„° 8ìë¦¬ í•´ì‹œ prefixë¥¼ ë§Œë“ ë‹¤.

        for lb_file in sorted(label_dir.glob("*.txt")):  # ë¼ë²¨ í´ë” ë‚´ ëª¨ë“  .txtë¥¼ ìˆœíšŒí•œë‹¤.
            stem = lb_file.stem  # ë¼ë²¨ íŒŒì¼ì˜ ë² ì´ìŠ¤ ì´ë¦„ì„ ì–»ëŠ”ë‹¤.
            try:
                im_file = try_find_image(frame_dir, stem)   # ê°™ì€ stemì˜ ì´ë¯¸ì§€ íŒŒì¼ì„ ì°¾ëŠ”ë‹¤.
            except FileNotFoundError as e:                  # ë§¤ì¹­ ì´ë¯¸ì§€ê°€ ì—†ìœ¼ë©´ ê²½ê³ í•˜ê³  ê±´ë„ˆë›´ë‹¤.
                print(f"[WARN] ë§¤ì¹­ ì´ë¯¸ì§€ ì—†ìŒ â†’ {e}")         # ì–´ë–¤ íŒŒì¼ì´ ëˆ„ë½ëëŠ”ì§€ ë¡œê·¸ë¥¼ ë‚¨ê¸´ë‹¤.
                continue

            im_name = f"{prefix}__{stem}{im_file.suffix}"   # ì¶©ëŒë°©ì§€ìš© ì´ë¯¸ì§€ ë§í¬ íŒŒì¼ëª…ì„ ë§Œë“ ë‹¤.
            lb_name = f"{prefix}__{stem}.txt"               # ì¶©ëŒë°©ì§€ìš© ë¼ë²¨ ë§í¬ íŒŒì¼ëª…ì„ ë§Œë“ ë‹¤.

            if use_train:  # í•™ìŠµ ë¶„í• ë¡œ ì‚¬ìš©í•˜ë©´
                symlink_force(im_file, img_tr / im_name)    # í•™ìŠµ ì´ë¯¸ì§€ ë§í¬ë¥¼ ìƒì„±/ê°±ì‹ í•œë‹¤.
                symlink_force(lb_file, lb_tr / lb_name)     # í•™ìŠµ ë¼ë²¨ ë§í¬ë¥¼ ìƒì„±/ê°±ì‹ í•œë‹¤.
                n_tr += 1                                   # ìƒì„± ê°œìˆ˜ë¥¼ ì¦ê°€ì‹œí‚¨ë‹¤.
            if use_val:  # ê²€ì¦ ë¶„í• ë¡œ ì‚¬ìš©í•˜ë©´
                symlink_force(im_file, img_va / im_name)    # ê²€ì¦ ì´ë¯¸ì§€ ë§í¬ë¥¼ ìƒì„±/ê°±ì‹ í•œë‹¤.
                symlink_force(lb_file, lb_va / lb_name)     # ê²€ì¦ ë¼ë²¨ ë§í¬ë¥¼ ìƒì„±/ê°±ì‹ í•œë‹¤.
                n_va += 1                                   # ìƒì„± ê°œìˆ˜ë¥¼ ì¦ê°€ì‹œí‚¨ë‹¤.

    # Ultralytics v8 ê·œì¹™ì„ ë”°ë¥´ëŠ” dataset.ymlì„ ìƒì„±í•œë‹¤.
    data_yaml = {  # YAML êµ¬ì¡°ë¥¼ ë”•ì…”ë„ˆë¦¬ë¡œ êµ¬ì„±í•œë‹¤.
        "path": str(stage_root),        # ìŠ¤í…Œì´ì§• ë£¨íŠ¸ë¥¼ pathë¡œ ì§€ì •í•œë‹¤.
        "train": "images/train",        # í•™ìŠµ ì´ë¯¸ì§€ëŠ” path/images/trainìœ¼ë¡œ ë‘”ë‹¤.
        "val": "images/val",            # ê²€ì¦ ì´ë¯¸ì§€ëŠ” path/images/valìœ¼ë¡œ ë‘”ë‹¤.
        "kpt_shape": [12, 3],           # 12ê°œ í‚¤í¬ì¸íŠ¸ì™€ (x,y,v) í¬ë§·ì„ ëª…ì‹œí•œë‹¤.
        "names": {0: "patient"},        # ë‹¨ì¼ í´ë˜ìŠ¤ëª…ì„ ì •ì˜í•œë‹¤.
        # "skeleton": [[10,8],[8,6],[11,9],[9,7],[6,7],[0,6],[1,7],[0,1],[0,2],[2,4],[1,3],[3,5]],  # í•„ìš”ì‹œ ìŠ¤ì¼ˆë ˆí†¤ì„ ì¶”ê°€í•œë‹¤.
        # "flip_idx": [...],  # ì¢Œìš° ë°˜ì „ ë§¤í•‘ì´ í•„ìš”í•˜ë©´ yolo12 ìˆœì„œì— ë§ê²Œ ì±„ìš´ë‹¤.
    }  

    with open(out_yaml, "w", encoding="utf-8") as f:  # dataset.yml íŒŒì¼ì„ ì—°ë‹¤.
        yaml.dump(data_yaml, f, sort_keys=False, allow_unicode=True)  # ì •ë ¬ì„ ìœ ì§€í•˜ê³  ìœ ë‹ˆì½”ë“œë¥¼ í—ˆìš©í•´ ì €ì¥í•œë‹¤.

    print(f"âœ… ìŠ¤í…Œì´ì§• ì™„ë£Œ: train={n_tr} val={n_va}")  # ìƒì„±ëœ ë§í¬ ê°œìˆ˜ë¥¼ ìš”ì•½ ì¶œë ¥í•œë‹¤.
    print(f"ğŸ“¦ STAGE_ROOT: {stage_root}")  # ìŠ¤í…Œì´ì§• ë£¨íŠ¸ ê²½ë¡œë¥¼ ì•Œë ¤ì¤€ë‹¤.
    print(f"ğŸ“ dataset.yml: {out_yaml}")  # ìƒì„±ëœ YAML ê²½ë¡œë¥¼ ì•Œë ¤ì¤€ë‹¤.

# ------------------------------------------------------------
# ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸
# ------------------------------------------------------------
if __name__ == "__main__":  # ìŠ¤í¬ë¦½íŠ¸ë¡œ ì§ì ‘ ì‹¤í–‰ë  ë•Œë§Œ ë™ì‘í•œë‹¤.
    build_stage_from_metadata(CSV_PATH, STAGE_ROOT, OUT_YAML)  # ë©”ì¸ í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•´ ëª¨ë“  ì‘ì—…ì„ ìˆ˜í–‰í•œë‹¤.
